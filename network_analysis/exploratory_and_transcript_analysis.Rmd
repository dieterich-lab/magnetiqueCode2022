---
title: "R Notebook"
output: html_notebook
---


Setting the seed for the analysis + loading the required libraries.

```{r}
#
set.seed(1234)

#
library(readr)
library(Rsubread)
library(vsn)
library(fgsea)
library(GSA)
library(pheatmap)
library(RColorBrewer)
library(circlize)
library(edgeR)
library(limma)
library(dplyr)
library(tidyr)
library(dorothea)
library(progeny)
library(viper)
library(stringr)
library(RColorBrewer)
library(gplots)
library(EnhancedVolcano)
library(readxl)
library(DESeq2)
library(ggplot2)
library(ggrepel)
library(CARNIVAL)
library(circlize)
library(ComplexHeatmap)
library(VennDiagram)
library(tibble)

source("~/Documents/src/plotDistributions.R")
source("~/Documents/src/createRegulonList.R")
source("~/Documents/src/support_functions.R")
```


Loading Data & Metadata + processing the counts.

```{r}
MAGE_metadata <- read.csv("~/Desktop/MAGE-Project/Data/MAGE_metadata.txt")

gene_count_matrix <- read_csv("~/Desktop/MAGE-Project/Data/gene_count_matrix.csv")
rNames <- gene_count_matrix$gene_id
gene_count_matrix <- gene_count_matrix[, 2:ncol(gene_count_matrix)]

counts <- gene_count_matrix
rownames(counts) <- rNames
colnames(counts) <- gsub(pattern = "_stringtieRef", replacement = "", x = colnames(counts), fixed = TRUE)

ensgID <- rownames(counts)
MappedID_MAGE <- read.delim("~/Desktop/MAGE-Project/Data/MappedID_MAGE_Stringtie.txt", header=FALSE)

counts <- as.data.frame(counts)

varQuant <- 0.01
countQuant <- 0.01

chk <- counts[rowSums(counts) > 10, ]
var.all <- apply(chk, 1, var)
chk <- chk[var.all > quantile(var.all, probs=varQuant, type=8), ]
sf <- DESeq2::estimateSizeFactorsForMatrix(chk)
cts.norm <- t(t(chk)/sf)
keep <- rowMeans(cts.norm) > quantile(rowMeans(cts.norm), probs=countQuant, type=8)
chk <- chk[keep,]

counts <- chk
```

Assigning Samples to Conditions.

```{r}
targets <- matrix(data = , nrow = ncol(counts), ncol = 2)
for(ii in 1:ncol(counts)){
  
  targets[ii, 1] <- colnames(counts)[ii]
  idx <- which(MAGE_metadata$Run==colnames(counts)[ii])
  if(length(idx) > 0){
    
    targets[ii, 2] <- MAGE_metadata$etiology[idx]
    
  }
  
}

targets <- as.data.frame(targets)
targets$V1 <- as.character(targets$V1)
targets$V2 <- as.character(targets$V2)
targets <- targets[-which(targets$V2==""), ]
idx2rem <- which(colnames(counts)%in%setdiff(x = colnames(counts), y = targets$V1))
counts <- counts[, -idx2rem]
colnames(targets) <- c("sample", "condition")

targets$condition[which(grepl(pattern = "Donor", x = targets$condition))] <- "Healthy"
targets$condition[which(grepl(pattern = "DCM", x = targets$condition))] <- "DCM"
targets$condition[which(grepl(pattern = "HCM", x = targets$condition))] <- "HCM"
targets$condition[which(grepl(pattern = "PPCM", x = targets$condition))] <- "PPCM"

targets$sample[which(targets$condition=="Healthy")] <- 
  paste0("Healthy_", 1:length(which(targets$condition=="Healthy")))

targets$sample[which(targets$condition=="DCM")] <- 
  paste0("DCM_", 1:length(which(targets$condition=="DCM")))

targets$sample[which(targets$condition=="HCM")] <- 
  paste0("HCM_", 1:length(which(targets$condition=="HCM")))

targets$sample[which(targets$condition=="PPCM")] <- 
  paste0("PPCM_", 1:length(which(targets$condition=="PPCM")))

idx2rem <- which(targets$condition=="PPCM")
targets <- targets[-idx2rem, ]
counts <- counts[, -idx2rem]

```


Normalizing counts and plotting the sample distributions.

```{r}
DGE <- DGEList(counts) %>%  calcNormFactors() 
data <- voom(DGE)
df <- data$E

df <- as.data.frame(df)
data <- df
```


PCA analysis of Samples.

```{r}
## All groups
data.pca <- t(df)
data.pca <- cbind(data.pca, as.matrix(targets))
data.pca <- as.data.frame(data.pca)
data.pca[, 1:(ncol(data.pca)-2)] <- lapply(data.pca[, 1:(ncol(data.pca)-2)], function(x) as.numeric(as.character(x)))

res.pca <- prcomp(data.pca[, -c(ncol(data.pca)-1, ncol(data.pca))], scale. = TRUE)
res.plot <-  as.data.frame(cbind(res.pca$x[, 1], res.pca$x[, 2], as.character(data.pca$condition), rownames(data.pca)))
res.plot[, 1:2] <- lapply(res.plot[, 1:2], function(x) as.numeric(as.character(x)))
res.plot[, 3:4] <- lapply(res.plot[, 3:4], function(x) as.character(x))
colnames(res.plot) <- c("pc1", "pc2", "Group", "sample")
percentages <- ((res.pca$sdev)^2 / sum(res.pca$sdev^2)*100)[1:2]

pp <- ggplot(res.plot, aes(x=pc1, y=pc2, color=Group)) +
  geom_point(size=2, alpha = 0.5) +
  scale_alpha_discrete(range=c(0.3, 1.0)) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=12,face="bold")) +
  xlab(paste0("PC1 (", round(x = percentages[1], digits = 2), "%)")) +
  ylab(paste0("PC2 (", round(x = percentages[2], digits = 2), "%)")) +
  xlim(c(-220, 220)) +
  ylim(c(-220, 220)) +
  theme(legend.position = "none") +
  geom_text_repel(data = res.plot, aes(label=sample), box.padding = 1.5, size=5)
plot(pp)
```


Performing DEG analysis with Limma and adding a column with mapped gene ID's on 
ttop's + saving the DEG results as excel files.

```{r}
ttopList <- list()

limmaRes <- runLimma(measurements = df, targets = targets, comparisons = list(c(3, -1)))
ttop <- topTable(fit = limmaRes[[1]], coef = 1, number = nrow(data), adjust.method = "fdr")
ttop$ID <- rownames(ttop)
ttopList[[length(ttopList)+1]] <- ttop

limmaRes <- runLimma(measurements = df, targets = targets, comparisons = list(c(2, -1)))
ttop <- topTable(fit = limmaRes[[1]], coef = 1, number = nrow(data), adjust.method = "fdr")
ttop$ID <- rownames(ttop)
ttopList[[length(ttopList)+1]] <- ttop

names(ttopList) <- c("DCM_vs_Healthy", "HCM_vs_Healthy")

MappedID_MAGE_Stringtie <- read.delim("Data/MappedID_MAGE_Stringtie.txt", header=FALSE)

ttopTemp <- list()
for(ii in 1:length(ttopList)){
  tmp <- ttopList[[ii]]
  for(jj in 1:nrow(tmp)){
    idx <- which(MappedID_MAGE_Stringtie$V1==tmp$ID[jj])
    if(length(idx)>0){
      vv <- MappedID_MAGE_Stringtie$V2[idx]
      if(vv==""){
        tmp$ID[jj] <- rownames(tmp)[jj]
      } else {
        tmp$ID[jj] <- MappedID_MAGE_Stringtie$V2[idx]
      }
    }
  }
  ttopTemp[[length(ttopTemp)+1]] <- tmp
}
ttopList <- ttopTemp
names(ttopList) <- c("DCM_vs_Healthy", "HCM_vs_Healthy")
```

Plotting results of the DEG analysis as volcano plots + highlighting the top 50
DEG's

```{r}
## DCM vs Healthy
temp <- ttopList[[1]]
  idx <- intersect(x = which(abs(temp$logFC)>2), y = which(temp$adj.P.Val<0.05))
  idx1 <- intersect(x = which(temp$logFC>2), y = which(temp$adj.P.Val<0.05))
  idx2 <- intersect(x = which(temp$logFC < -2), y = which(temp$adj.P.Val<0.05))
  EnhancedVolcano(toptable = temp, lab = temp$ID, x = "logFC", y = "adj.P.Val", pCutoff = 0.05, FCcutoff = 1,
                  pointSize = 3, title = "Volcano plot of differentially expressed genes",
                  subtitle = paste0(length(idx), " significantly enriched genes (pCutoff = 0.05, Log-FCcutoff = 2): ", length(idx1), " up & ", length(idx2), " down"))
  
  idx1 <- which(targets$condition==strsplit(x = names(ttopList)[ii], split = "_vs_", fixed = TRUE)[[1]][1])
  idx2 <- which(targets$condition==strsplit(x = names(ttopList)[ii], split = "_vs_", fixed = TRUE)[[1]][2])
  top50 <- rownames(temp)[order(abs(temp$logFC), decreasing = TRUE)[1:50]]
  select <- which(rownames(data)%in%top50)
  mycol <- colorRamp2(c(-3,0,3), c("dodgerblue", "black", "yellow"))
  mm <- as.matrix(data)[select, c(idx1, idx2)]
  Heatmap(scale(mm), col=mycol, cluster_columns = FALSE, cluster_rows = TRUE,
          column_title = "Expression heatmap of top 50 regulated genes", 
          width = 60, height = 40)
  
## HCM vs Healthy
temp <- ttopList[[2]]
  idx <- intersect(x = which(abs(temp$logFC)>2), y = which(temp$adj.P.Val<0.05))
  idx1 <- intersect(x = which(temp$logFC>2), y = which(temp$adj.P.Val<0.05))
  idx2 <- intersect(x = which(temp$logFC < -2), y = which(temp$adj.P.Val<0.05))
  EnhancedVolcano(toptable = temp, lab = temp$ID, x = "logFC", y = "adj.P.Val", pCutoff = 0.05, FCcutoff = 1,
                  pointSize = 3, title = "Volcano plot of differentially expressed genes",
                  subtitle = paste0(length(idx), " significantly enriched genes (pCutoff = 0.05, Log-FCcutoff = 2): ", length(idx1), " up & ", length(idx2), " down"))
  
  idx1 <- which(targets$condition==strsplit(x = names(ttopList)[ii], split = "_vs_", fixed = TRUE)[[1]][1])
  idx2 <- which(targets$condition==strsplit(x = names(ttopList)[ii], split = "_vs_", fixed = TRUE)[[1]][2])
  top50 <- rownames(temp)[order(abs(temp$logFC), decreasing = TRUE)[1:50]]
  select <- which(rownames(data)%in%top50)
  mycol <- colorRamp2(c(-3,0,3), c("dodgerblue", "black", "yellow"))
  mm <- as.matrix(data)[select, c(idx1, idx2)]
  Heatmap(scale(mm), col=mycol, cluster_columns = FALSE, cluster_rows = TRUE,
          column_title = "Expression heatmap of top 50 regulated genes",
          width = 60, height = 40)
```


Sample-wise pathway activity estimation analysis with PROGENy.

```{r}
data <- as.matrix(df)

genesMapped <- rep("", nrow(data))
for(ii in 1:length(genesMapped)){
  genesMapped[ii] <- MappedID_MAGE_Stringtie$V2[which(MappedID_MAGE_Stringtie$V1==rownames(data)[ii])]
}

idx2rem <- which(genesMapped=="")
data <- data[-idx2rem, ]
genesMapped <- genesMapped[-idx2rem]
uGenes <- unique(genesMapped)

dd <- matrix(data = , nrow = length(uGenes), ncol = ncol(data))
rownames(dd) <- uGenes
colnames(dd) <- colnames(data)

for(ii in 1:nrow(dd)){
  
  idx <- which(genesMapped==uGenes[ii])
  if(length(idx)==1){
    dd[ii, ] <- data[idx, ]
  } else {
    dd[ii, ] <- colMedians(x = data[idx, ])
  }
  
}

PathwayActivity_counts <- progeny(dd, scale=TRUE, organism="Human", top = 100)
Activity_counts <- as.vector(PathwayActivity_counts)

paletteLength <- 100
myColor <- 
  colorRampPalette(c("darkblue", "whitesmoke","indianred"))(paletteLength)

progenyBreaks <- c(seq(min(Activity_counts), 0, 
                       length.out=ceiling(paletteLength/2) + 1),
                   seq(max(Activity_counts)/paletteLength, 
                       max(Activity_counts), 
                       length.out=floor(paletteLength/2)))

idxOrder <- c(which(targets$condition=="Healthy"), 
              which(targets$condition=="DCM", 
              which(targets$condition=="HCM")))
pheatmap(t(PathwayActivity_counts[idxOrder, ]),fontsize=14, 
                         fontsize_row = 10, fontsize_col = 10, 
                         color=myColor, breaks = progenyBreaks, 
                         main = "PROGENy Samplewise Activities", angle_col = NULL,
                         treeheight_col = 0,  border_color = NA)

for(ii in 1:length(ttopList)){
  
  if(ii==1){
    currSample <- "DCM"
  } else {
    currSample <- "HCM"
  }
  
  progeny_sample <- PathwayActivity_counts
  
  idx1 <- which(targets$condition=="Healthy")
  rownames(progeny_sample)[idx1] <- paste0("Healthy_", 1:length(idx1))
  
  idx2 <- which(targets$condition==currSample)
  rownames(progeny_sample)[idx2] <- paste0(currSample, 1:length(idx2))
  
  idx2rem <- setdiff(x = 1:nrow(progeny_sample), y = c(idx1, idx2))
  
  progeny_sample <- progeny_sample[-idx2rem, ]  
    
    bb <- matrix(data = , nrow = nrow(progeny_sample)*ncol(progeny_sample), ncol = 3)
    colnames(bb) <- c("Pathway", "Condition", "Activity")
    cnt <- 1
    for(ll in 1:nrow(progeny_sample)){

      for(jj in 1:ncol(progeny_sample)){

        bb[cnt, 1] <- colnames(progeny_sample)[jj]

        if(grepl(pattern = "Healthy", x = rownames(progeny_sample)[ll], fixed = TRUE)){
          bb[cnt, 2] <- "Healthy"
        } else{
          bb[cnt, 2] <- strsplit(x = names(ttopList)[ii], split = "_", fixed = TRUE)[[1]][1]
        }

        bb[cnt, 3] <- as.numeric(progeny_sample[ll, jj])

        cnt <- cnt + 1
      }

    }
    bb <- as.data.frame(bb)
    bb$Pathway <- as.character(bb$Pathway)
    bb$Condition <- as.character(bb$Condition)
    bb$Activity <- as.numeric(as.character(bb$Activity))

    pp <- ggplot(bb, aes(x=Pathway, y=Activity, fill=Condition)) +
      geom_boxplot(position=position_dodge(1))
    plot(pp)
  
}
```


Differentially regulated pathway analysis with PROGENy + highlighting the main
drivers of pathway activity for the JAK-STAT and Androgen pathways.

```{r}
for(ii in 1:length(ttopList)){
  
  stats <- ttopList[[ii]]$logFC
  names(stats) <- ttopList[[ii]]$ID
  uID <- unique(names(stats))
  ss <- matrix(data = , nrow = length(uID), ncol = 1)
  rownames(ss) <- uID
  colnames(ss) <- names(ttopList)[ii]
  for(jj in 1:nrow(ss)){
    idx <- which(uID==rownames(ss)[jj])
    ss[jj, 1] <- median(as.numeric(stats[idx]))
  }
  PathwayActivity_zscore <- progeny(ss, scale=FALSE, organism="Human", 
                                    top = 100, perm = 10000, z_scores = TRUE) %>%
    t()
  colnames(PathwayActivity_zscore) <- "NES"
  
  PathwayActivity_zscore_df <- as.data.frame(PathwayActivity_zscore) %>% 
    rownames_to_column(var = "Pathway") %>%
    dplyr::arrange(NES) %>%
    dplyr::mutate(Pathway = factor(Pathway))
  
  pp <- ggplot(PathwayActivity_zscore_df,aes(x = reorder(Pathway, NES), y = NES)) + 
    geom_bar(aes(fill = NES), stat = "identity") +
    scale_fill_gradient2(low = "darkblue", high = "indianred", 
                         mid = "whitesmoke", midpoint = 0) + 
    theme_minimal() +
    theme(axis.title = element_text(face = "bold", size = 12),
          axis.text.x = 
            element_text(angle = 45, hjust = 1, size =10, face= "bold"),
          axis.text.y = element_text(size =10, face= "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank()) +
    xlab("Pathways")
  plot(pp)
  
  prog_matrix <- getModel("Human", top=100) %>% 
    as.data.frame()  %>%
    tibble::rownames_to_column("GeneID")
  
  ss <- ss %>% 
    as.data.frame() %>% 
    tibble::rownames_to_column("GeneID")
  
  scat_plots <- progeny::progenyScatter(df = ss, 
                                        weight_matrix = prog_matrix, 
                                        statName = "t_values", verbose = FALSE)
  
  plot(scat_plots[[1]]$`JAK-STAT`)
  
  plot(scat_plots[[1]]$`Androgen`)
  
}

```


Transcription Factor analysis with DoRothEA resource and Viper enrichment 
method.


```{r}
data(dorothea_hs, package = "dorothea")
regulons <- dorothea_hs %>%
  dplyr::filter(confidence %in% c("A", "B","C"))

tfList <- list()
for(ii in 1:length(ttopList)){
  
  stats <- ttopList[[ii]]$logFC
  names(stats) <- ttopList[[ii]]$ID
  uID <- unique(names(stats))
  ss <- matrix(data = , nrow = length(uID), ncol = 1)
  rownames(ss) <- uID
  colnames(ss) <- names(ttopList)[ii]
  for(jj in 1:nrow(ss)){
    idx <- which(uID==rownames(ss)[jj])
    ss[jj, 1] <- median(as.numeric(stats[idx]))
  }
  
  tf_activities_stat <- dorothea::run_viper(ss, regulons,
                                            options =  list(minsize = 5, eset.filter = FALSE, 
                                                            cores = 1, verbose = FALSE, nes = TRUE))
  colnames(tf_activities_stat) <- "t"
  
  tmp <- as.matrix(tf_activities_stat[order(abs(tf_activities_stat[, 1]), decreasing = TRUE), ])
  tmp <- as.data.frame(tmp)
  colnames(tmp) <- "t"
  tmp$id <- rownames(tmp)
  tmp <- tmp[, c(2, 1)]
  tmp$t <- as.character(tmp$t)
  
  tf_activities_stat_top25 <- tf_activities_stat %>%
    as.data.frame() %>% 
    rownames_to_column(var = "GeneID") %>%
    dplyr::rename(NES = "t") %>%
    dplyr::top_n(25, wt = abs(NES)) %>%
    dplyr::arrange(NES) %>% 
    dplyr::mutate(GeneID = factor(GeneID))
  
  pp <- ggplot(tf_activities_stat_top25,aes(x = reorder(GeneID, NES), y = NES)) + 
    geom_bar(aes(fill = NES), stat = "identity") +
    scale_fill_gradient2(low = "darkblue", high = "indianred", 
                         mid = "whitesmoke", midpoint = 0) + 
    theme_minimal() +
    theme(axis.title = element_text(face = "bold", size = 12),
          axis.text.x = 
            element_text(angle = 45, hjust = 1, size =10, face= "bold"),
          axis.text.y = element_text(size =10, face= "bold"),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank()) +
    xlab("Transcription Factors")
  plot(pp)
  
  
  tf_activities_stat_top50 <- tf_activities_stat %>%
    as.data.frame() %>% 
    rownames_to_column(var = "GeneID") %>%
    dplyr::rename(NES = "t") %>%
    dplyr::top_n(50, wt = abs(NES)) %>%
    dplyr::arrange(NES) %>% 
    dplyr::mutate(GeneID = factor(GeneID))
  
  tfList[[length(tfList)+1]] <- tf_activities_stat_top50
  
}
```
